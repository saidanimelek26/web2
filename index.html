<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Linux ADK Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      content: [],
      theme: { extend: {} },
      plugins: [],
    };
  </script>
  <style>
    body {
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const defaultAccessory = {
      manufacturer: "Samsung Electronics Co., Ltd.",
      model: "Galaxy A05",
      description: "Sample Program",
      version: "1.0",
      url: window.location.href, // Use current page URL
      serial: "0000000012345678",
    };

    // Device filters without ADB-related PIDs
    const DEVICE_FILTERS = [
      { vendorId: 0x18D1 }, // Google
      { vendorId: 0x04E8, productId: 0x6860 }, // Samsung Galaxy
      { vendorId: 0x04E8 }, // Samsung (general)
      { vendorId: 0x12D1 }, // Huawei
      { vendorId: 0x2717 }, // Xiaomi
      { vendorId: 0x22D9 }, // Oppo
      { vendorId: 0x2D95 }, // Vivo
      { vendorId: 0x054C }, // Sony
      { vendorId: 0x1004 }, // LG
      { vendorId: 0x22B8 }, // Motorola
      { vendorId: 0x0BB4 }, // HTC
      { vendorId: 0x2A70 }, // OnePlus
      { vendorId: 0x17EF }, // Lenovo
      { vendorId: 0x0B05 }, // Asus
      { vendorId: 0x19D2 }, // ZTE
      { vendorId: 0x2E04 }, // Nokia (HMD Global)
      { vendorId: 0x18D1, productId: 0x2D00 }, // AOA Accessory
      { vendorId: 0x18D1, productId: 0x2D02 }, // AOA Audio
      { vendorId: 0x18D1, productId: 0x2D04 }, // AOA Accessory + Audio
    ];

    const VENDOR_NAMES = {
      0x18D1: "Google",
      0x04E8: "Samsung",
      0x12D1: "Huawei",
      0x2717: "Xiaomi",
      0x22D9: "Oppo",
      0x2D95: "Vivo",
      0x054C: "Sony",
      0x1004: "LG",
      0x22B8: "Motorola",
      0x0BB4: "HTC",
      0x2A70: "OnePlus",
      0x17EF: "Lenovo",
      0x0B05: "Asus",
      0x19D2: "ZTE",
      0x2E04: "Nokia",
    };

    const AOA_GET_PROTOCOL = 51;
    const AOA_SEND_IDENT = 52;
    const AOA_START_ACCESSORY = 53;
    const AOA_AUDIO_SUPPORT = 58;

    const AOA_STRING_MAN_ID = 0;
    const AOA_STRING_MOD_ID = 1;
    const AOA_STRING_DSC_ID = 2;
    const AOA_STRING_VER_ID = 3;
    const AOA_STRING_URL_ID = 4;
    const AOA_STRING_SER_ID = 5;

    function App() {
      const [accessory, setAccessory] = React.useState(defaultAccessory);
      const [logs, setLogs] = React.useState([]);
      const [device, setDevice] = React.useState(null);
      const [aoaVersion, setAoaVersion] = React.useState(null);
      const [isConnected, setIsConnected] = React.useState(false);
      const [deviceId, setDeviceId] = React.useState(null);

      const addLog = (message) => {
        setLogs((prev) => [...prev, message]);
      };

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setAccessory((prev) => ({ ...prev, [name]: value }));
      };

      const getVendorName = (vendorId) => {
        return VENDOR_NAMES[vendorId] || "Unknown Vendor";
      };

      const connectDevice = async () => {
        if (!navigator.usb) {
          addLog("WebUSB is not supported in this browser (use Chrome). Using mock data.");
          simulateDeviceConnection();
          return;
        }

        try {
          // Log available USB devices for debugging
          const devices = await navigator.usb.getDevices();
          addLog(`Found ${devices.length} USB devices:`);
          devices.forEach((d) =>
            addLog(`- ${d.productName || "Unknown"} (VID: 0x${d.vendorId.toString(16).padStart(4, "0")}, PID: 0x${d.productId.toString(16).padStart(4, "0")})`)
          );

          const device = await navigator.usb.requestDevice({
            filters: DEVICE_FILTERS,
          });
          await device.open();
          setDevice(device);

          // Generate unique device ID
          const uniqueId = device.serialNumber || `${device.vendorId.toString(16).padStart(4, "0")}:${device.productId.toString(16).padStart(4, "0")}:${Date.now()}`;
          setDeviceId(uniqueId);

          addLog(`Connected to device: ${device.productName || "Unknown Device"}`);
          addLog(`Vendor: ${getVendorName(device.vendorId)} (VID: 0x${device.vendorId.toString(16).padStart(4, "0")})`);
          addLog(`Product ID: 0x${device.productId.toString(16).padStart(4, "0")}`);
          addLog(`Device ID: ${uniqueId}`);
          setIsConnected(true);
          await initializeAccessory(device);
        } catch (error) {
          addLog(`Error connecting to device: ${error.message}`);
          if (error.message.includes("No device selected")) {
            addLog("No device was selected. Ensure the device is connected and matches the VID/PID filters.");
            addLog("Falling back to mock mode.");
            simulateDeviceConnection();
          } else if (error.message.includes("Access denied")) {
            addLog("Access denied error detected. Troubleshooting steps:");
            addLog("1. Restart your PC to close any interfering programs.");
            addLog("2. On Linux: Create /etc/udev/rules.d/50-usb.rules with specific vendor rules, e.g., 'SUBSYSTEM==\"usb\", ATTR{idVendor}==\"04e8\", MODE=\"0666\", GROUP=\"plugdev\"', then run 'sudo udevadm control --reload-rules && sudo udevadm trigger'. Add user to 'plugdev': 'sudo usermod -aG plugdev $USER'. Log out/in.");
            addLog("3. On Windows: Download Zadig (zadig.akeo.ie), select your device, install WinUSB driver.");
            addLog("4. On macOS: Ensure no other apps (e.g., Samsung Smart Switch) are using the device; restart if needed.");
            addLog("5. Unplug/replug the device and try again. Site must be on HTTPS.");
            addLog("Falling back to mock mode due to access error.");
            simulateDeviceConnection();
          } else {
            addLog("Unexpected error. Falling back to mock mode.");
            simulateDeviceConnection();
          }
        }
      };

      const simulateDeviceConnection = () => {
        const mockDevice = {
          productName: "Mock Samsung Galaxy",
          vendorId: 0x04E8,
          productId: 0x6860,
          serialNumber: "MOCK123456789",
          mock: true,
        };
        setDevice(mockDevice);
        setDeviceId(mockDevice.serialNumber);
        setIsConnected(true);
        addLog("Simulating device connection with mock data.");
        addLog(`Mock Device ID: ${mockDevice.serialNumber}`);
        initializeAccessory(mockDevice);
      };

      const initializeAccessory = async (device) => {
        try {
          addLog("Checking if device supports AOA protocol...");
          const aoaVersion = await getAoaProtocol(device);
          setAoaVersion(aoaVersion);
          addLog(`Device supports AOA ${aoaVersion}.0`);

          if (aoaVersion >= 2) {
            addLog("Requesting audio support...");
            await requestAudioSupport(device);
          }

          addLog("Sending identification to the device...");
          await sendIdentification(device, { ...accessory, url: window.location.href });

          addLog("Turning device into Accessory mode...");
          await startAccessoryMode(device);

          addLog("Device initialized successfully!");
          startDataSnooping(device);
        } catch (error) {
          addLog(`Initialization failed: ${error.message}`);
          if (error.message.includes("transfer error")) {
            addLog("AOA protocol not supported or transfer issue detected.");
            addLog("Troubleshooting steps:");
            addLog("1. Ensure the device supports AOA (check manufacturer specs).");
            addLog("2. Try a different USB cable or port (ensure it's a data cable).");
            addLog("3. Verify the device is in a compatible USB mode (e.g., MTP, not charging-only).");
            addLog("4. Check permissions (see connection logs for OS-specific steps).");
            addLog("Falling back to mock mode.");
            simulateDeviceConnection();
          } else {
            addLog("Unexpected initialization error. Falling back to mock.");
            simulateDeviceConnection();
          }
        }
      };

      const getAoaProtocol = async (device) => {
        if (device.mock) return 2;
        try {
          const result = await device.controlTransferIn({
            requestType: "vendor",
            recipient: "device",
            request: AOA_GET_PROTOCOL,
            value: 0,
            index: 0,
          }, 2);
          if (result.status === "ok") {
            const buffer = new Uint8Array(result.data.buffer);
            return (buffer[1] << 8) | buffer[0];
          }
          throw new Error("Failed to get AOA protocol response");
        } catch (error) {
          throw new Error(`AOA check failed: ${error.message}`);
        }
      };

      const sendIdentification = async (device, acc) => {
        const fields = [
          { id: AOA_STRING_MAN_ID, value: acc.manufacturer },
          { id: AOA_STRING_MOD_ID, value: acc.model },
          { id: AOA_STRING_DSC_ID, value: acc.description },
          { id: AOA_STRING_VER_ID, value: acc.version },
          { id: AOA_STRING_URL_ID, value: acc.url },
          { id: AOA_STRING_SER_ID, value: acc.serial },
        ];

        for (const field of fields) {
          if (field.value) {
            addLog(`Sending ${field.id === AOA_STRING_MAN_ID ? "manufacturer" : field.id === AOA_STRING_MOD_ID ? "model" : field.id === AOA_STRING_DSC_ID ? "description" : field.id === AOA_STRING_VER_ID ? "version" : field.id === AOA_STRING_URL_ID ? "url" : "serial"}: ${field.value}`);
            if (!device.mock) {
              const data = new TextEncoder().encode(field.value + "\0");
              await device.controlTransferOut({
                requestType: "vendor",
                recipient: "device",
                request: AOA_SEND_IDENT,
                value: 0,
                index: field.id,
              }, data);
            }
          }
        }
      };

      const requestAudioSupport = async (device) => {
        if (device.mock) return;
        await device.controlTransferOut({
          requestType: "vendor",
          recipient: "device",
          request: AOA_AUDIO_SUPPORT,
          value: 1,
          index: 0,
        });
      };

      const startAccessoryMode = async (device) => {
        if (device.mock) return;
        await device.controlTransferOut({
          requestType: "vendor",
          recipient: "device",
          request: AOA_START_ACCESSORY,
          value: 0,
          index: 0,
        });
      };

      const startDataSnooping = async (device) => {
        if (device.mock) {
          setInterval(() => {
            const mockData = new Uint8Array([0x41, 0x42, 0x43, 0x44]);
            addLog(`Received ${mockData.length} bytes: ${Array.from(mockData).map(b => `0x${b.toString(16).padStart(2, "0")}`).join(" ")}`);
          }, 2000);
          return;
        }

        try {
          await device.selectConfiguration(1);
          await device.claimInterface(0);
          while (true) {
            const result = await device.transferIn(0x81, 512);
            if (result.status === "ok") {
              const data = new Uint8Array(result.data.buffer);
              addLog(`Received ${data.length} bytes: ${Array.from(data).map(b => `0x${b.toString(16).padStart(2, "0")}`).join(" ")}`);
            } else {
              addLog("Transfer error");
            }
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        } catch (error) {
          addLog(`Snooping error: ${error.message}`);
        }
      };

      const disconnectDevice = async () => {
        if (device && !device.mock) {
          try {
            await device.close();
            addLog("Device disconnected");
          } catch (error) {
            addLog(`Error disconnecting: ${error.message}`);
          }
        }
        setDevice(null);
        setDeviceId(null);
        setIsConnected(false);
        setAoaVersion(null);
      };

      return (
        <div className="bg-white p-6 rounded-lg shadow-lg">
          <h1 className="text-2xl font-bold mb-4">Linux ADK Web</h1>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            {Object.keys(defaultAccessory).map((key) => (
              <div key={key} className="flex flex-col">
                <label className="font-semibold capitalize">{key}</label>
                <input
                  type="text"
                  name={key}
                  value={accessory[key]}
                  onChange={handleInputChange}
                  className="border p-2 rounded"
                  disabled={isConnected}
                />
              </div>
            ))}
          </div>
          <div className="flex space-x-4 mb-4">
            <button
              onClick={connectDevice}
              disabled={isConnected}
              className="bg-blue-500 text-white p-2 rounded disabled:bg-gray-400"
            >
              Connect Device
            </button>
            <button
              onClick={disconnectDevice}
              disabled={!isConnected}
              className="bg-red-500 text-white p-2 rounded disabled:bg-gray-400"
            >
              Disconnect
            </button>
          </div>
          {deviceId && (
            <div className="mb-4">
              <h2 className="text-lg font-semibold">Device ID</h2>
              <p className="font-mono text-sm">{deviceId}</p>
            </div>
          )}
          <div className="bg-gray-800 text-white p-4 rounded h-64 overflow-y-auto">
            <h2 className="text-lg font-semibold mb-2">Logs</h2>
            {logs.map((log, index) => (
              <p key={index} className="font-mono text-sm">{log}</p>
            ))}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
